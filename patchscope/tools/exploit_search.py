"""Exploit search client â€” queries Exploit-DB and GitHub for public exploits/PoCs."""

import os
import re
import time

import requests
from dotenv import load_dotenv

load_dotenv()


def _github_headers() -> dict:
    """Build standard GitHub API headers with optional auth."""
    headers = {"Accept": "application/vnd.github.v3+json"}
    token = os.environ.get("GITHUB_TOKEN")
    if token:
        headers["Authorization"] = f"token {token}"
    return headers


# ---------------------------------------------------------------------------
# Exploit-DB search (via the exploits.shodan.io / GitLab mirror API)
# ---------------------------------------------------------------------------

_EXPLOITDB_API = "https://exploits.shodan.io/api/search"
_EXPLOITDB_GITLAB_API = "https://gitlab.com/api/v4/projects/exploit-database%2Fexploitdb/repository/tree"


def search_exploit_db(cve_id: str) -> list[dict]:
    """Search Exploit-DB for public exploits matching a CVE ID.

    Searches the Exploit-DB GitLab mirror for files referencing the CVE.

    Args:
        cve_id: CVE identifier, e.g. "CVE-2023-32233".

    Returns:
        List of dicts with keys: title, url, edb_id (if extractable).
    """
    # Strategy: search GitHub for exploit-db mirrors referencing this CVE
    # The official Exploit-DB is on GitLab; we search GitHub mirrors as a
    # more reliable programmatic approach.
    results = []

    try:
        resp = requests.get(
            "https://api.github.com/search/code",
            params={
                "q": f"{cve_id} repo:offensive-security/exploitdb",
                "per_page": 5,
            },
            headers={
                **_github_headers(),
                "Accept": "application/vnd.github.v3.text-match+json",
            },
            timeout=30,
        )
        resp.raise_for_status()
        data = resp.json()

        for item in data.get("items", [])[:5]:
            path = item.get("path", "")
            edb_id = _extract_edb_id(path)
            results.append({
                "title": item.get("name", path),
                "path": path,
                "url": f"https://www.exploit-db.com/exploits/{edb_id}" if edb_id else item.get("html_url", ""),
                "edb_id": edb_id,
                "source": "exploit-db",
            })
    except requests.RequestException:
        pass  # Fallback below

    return results


def _extract_edb_id(path: str) -> str | None:
    """Extract Exploit-DB ID from a file path like 'exploits/linux/local/12345.py'."""
    match = re.search(r"/(\d{4,6})\.\w+$", path)
    return match.group(1) if match else None


# ---------------------------------------------------------------------------
# GitHub PoC search
# ---------------------------------------------------------------------------

def search_github_pocs(cve_id: str) -> list[dict]:
    """Search GitHub repositories for proof-of-concept exploit code.

    Looks for repos named after the CVE or containing PoC/exploit code.

    Args:
        cve_id: CVE identifier, e.g. "CVE-2023-32233".

    Returns:
        List of dicts with keys: repo, url, description, stars.
    """
    results = []

    try:
        resp = requests.get(
            "https://api.github.com/search/repositories",
            params={
                "q": f"{cve_id} in:name,description,readme",
                "sort": "stars",
                "order": "desc",
                "per_page": 10,
            },
            headers=_github_headers(),
            timeout=30,
        )
        resp.raise_for_status()
        data = resp.json()

        for item in data.get("items", [])[:10]:
            results.append({
                "repo": item["full_name"],
                "url": item["html_url"],
                "description": (item.get("description") or "")[:300],
                "stars": item.get("stargazers_count", 0),
                "language": item.get("language", ""),
                "source": "github",
            })
    except requests.RequestException:
        pass

    return results


# ---------------------------------------------------------------------------
# Metasploit module search
# ---------------------------------------------------------------------------

def search_metasploit_modules(cve_id: str) -> list[dict]:
    """Search the Metasploit Framework repo for modules targeting a CVE.

    Searches the rapid7/metasploit-framework GitHub repo for references
    to the CVE ID in module source files.

    Args:
        cve_id: CVE identifier, e.g. "CVE-2023-32233".

    Returns:
        List of dicts with keys: module_path, url, source.
    """
    results = []

    try:
        resp = requests.get(
            "https://api.github.com/search/code",
            params={
                "q": f"{cve_id} repo:rapid7/metasploit-framework",
                "per_page": 5,
            },
            headers={
                **_github_headers(),
                "Accept": "application/vnd.github.v3.text-match+json",
            },
            timeout=30,
        )
        resp.raise_for_status()
        data = resp.json()

        for item in data.get("items", [])[:5]:
            path = item.get("path", "")
            results.append({
                "module_path": path,
                "url": item.get("html_url", ""),
                "name": item.get("name", ""),
                "source": "metasploit",
            })
    except requests.RequestException:
        pass

    return results
